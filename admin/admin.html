<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω RSVP</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
      .hidden {
        display: none;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
      }
      th {
        background-color: #f2f2f2;
      }

      .media-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .media-wrapper img {
        width: 300px;
        height: 100px;
        object-fit: cover;
        border-radius: 6px;
      }
    </style>

    <style>
      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      .popup-content {
        background: white;
        padding: 10px;
        border-radius: 10px;
        position: relative;
        width: 90%;
        max-width: 800px;
        height: 90%;
      }

      .popup iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 6px;
      }

      .close-btn {
        position: absolute;
        top: 5px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h2>üë• Danh s√°ch</h2>
    <div style="text-align: right; margin-top: 10px">
      <button onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
    </div>

    <form id="rsvpForm">
      <input type="text" id="name" placeholder="T√™n thi·ªáp" required /><br />
      <input
        type="text"
        id="url"
        placeholder="URL thi·ªáp"
        required
        style="width: 500px"
      /><br />
      <input
        type="text"
        id="img"
        placeholder="H√¨nh ·∫£nh thumbmail"
        required
        style="width: 1000px"
      /><br />
      <button type="submit">Th√™m m·ªõi</button>
    </form>
    <!-- üß© Th√™m √¥ t√¨m ki·∫øm -->
    <div style="text-align: right; margin-top: 10px">
      <input
        type="text"
        id="searchInput"
        placeholder="üîç T√¨m ki·∫øm theo t√™n thi·ªáp..."
        style="padding: 5px; width: 300px"
      />
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 25px">T√™n thi·ªáp</th>
          <th style="width: 275px">URL thi·ªáp</th>
          <th style="width: 275px">H√¨nh ·∫£nh thumbmail</th>
          <th style="width: 80px">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="rsvpTableBody"></tbody>
    </table>

    <!-- Popup -->
    <div id="popup" class="popup hidden">
      <div class="popup-content">
        <span class="close-btn">&times;</span>
        <iframe id="popupFrame" src="" frameborder="0" allowfullscreen></iframe>
      </div>
    </div>

    <script src="../js/config.js"></script>
    <script>
      const { createClient } = supabase;
      const supabaseClient = createClient(
        CONFIG.SUPABASE_URL,
        CONFIG.SUPABASE_KEY
      );

      // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p th√¨ quay v·ªÅ login
      if (localStorage.getItem("loggedInAdmin") !== "true") {
        window.location.href = "login.html";
      }

      function logout() {
        localStorage.removeItem("loggedInAdmin");
        window.location.href = "login.html";
      }

      document
        .getElementById("rsvpForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("name").value.trim();
          const url = document.getElementById("url").value.trim();
          const img = document.getElementById("img").value.trim();

          const { error } = await supabaseClient
            .from("list_theme")
            .insert([{ name, url, img }]);
          if (error) return alert("‚ùå Th√™m th·∫•t b·∫°i: " + error.message);
          e.target.reset();
          loadData();
        });

      let allThemes = [];

      async function loadData() {
        const { data, error } = await supabaseClient
          .from("list_theme")
          .select("*")
          .order("id", { ascending: false });

        if (error) {
          document.getElementById(
            "rsvpTableBody"
          ).innerHTML = `<tr><td colspan="4">‚ö†Ô∏è L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`;
          return;
        }

        allThemes = data;
        renderData(allThemes);
      }

      function renderData(data) {
        const tbody = document.getElementById("rsvpTableBody");
        tbody.innerHTML = "";

        data.forEach((item) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${item.name}</td>
        <td>${item.url}</td>
        <td>
          <div class="media-wrapper">
            <img src="${item.img}" alt="${item.name}" />
            <span class="open-card" data-url="${
              item.url
            }" style="cursor:pointer;">üñºÔ∏è M·ªü thi·ªáp</span>
          </div>
        </td>
        <td>
          <a href="edit.html?id=${item.id}">‚úèÔ∏è S·ª≠a</a><br><br><br>
          <a href="#" onclick="deleteEntry(${item.id}, '${item.name.replace(
            /'/g,
            "\\'"
          )}')">üóëÔ∏è Xo√°</a>
        </td>
      `;
          tbody.appendChild(tr);
        });
      }

      // üîç T√¨m ki·∫øm theo t√™n thi·ªáp
      document.getElementById("searchInput").addEventListener("input", (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allThemes.filter((item) =>
          item.name.toLowerCase().includes(keyword)
        );
        renderData(filtered);
      });

      async function deleteEntry(id, name) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° " + name + " kh√¥ng ?")) return;

        const { error } = await supabaseClient
          .from("list_theme")
          .delete()
          .eq("id", id);

        if (error) return alert("‚ùå Xo√° th·∫•t b·∫°i: " + error.message);
        loadData();
      }

      loadData();
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const popup = document.getElementById("popup");
        const popupFrame = document.getElementById("popupFrame");
        const closeBtn = document.querySelector(".close-btn");

        document.body.addEventListener("click", function (e) {
          if (e.target.classList.contains("open-card")) {
            const url = e.target.dataset.url;
            popupFrame.src = url;
            popup.classList.remove("hidden");
          }
          if (e.target === closeBtn || e.target === popup) {
            popup.classList.add("hidden");
            popupFrame.src = "";
          }
        });
      });
    </script>
  </body>
</html>
